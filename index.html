<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>SC THE ADVENTURE | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Realtime)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">

<style>
:root{--primary:#2563eb;--danger:#dc2626;--success:#16a34a;--bg:#f1f5f9}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg)}
header{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:20px 30px;font-size:24px;font-weight:700}
.container{padding:32px;max-width:1700px;margin:auto}
button,input,select,textarea{width:100%;padding:14px;border-radius:16px;border:1px solid #c7d2fe;font-size:14px}
button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;transition:.2s}
button:hover{transform:translateY(-2px)}
button.danger{background:var(--danger)}
.card{background:#fff;border-radius:28px;padding:30px;margin-bottom:30px;box-shadow:0 25px 50px rgba(0,0,0,.15)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:28px}
.table{width:100%;border-collapse:collapse;border-radius:26px;overflow:hidden}
th,td{padding:18px;border-bottom:1px solid #e5e7eb;vertical-align:top}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:10}
.modal-box{background:#fff;width:96%;max-width:1500px;border-radius:36px;padding:44px;max-height:92vh;overflow:auto}
.section-title{font-size:18px;font-weight:700;margin-bottom:12px}
.badge{padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700}
.NEW{background:#fee2e2;color:#991b1b}
.INPROGRESS{background:#fef3c7;color:#92400e}
.DONE{background:#dcfce7;color:#166534}

/* toast */
.toast{
  position:fixed;top:24px;right:24px;
  background:#fff;padding:16px 24px;border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.2);
  display:none;z-index:999
}
.toast.success{border-left:8px solid var(--success)}
.toast.error{border-left:8px solid var(--danger)}
</style>
</head>

<body>
<header>üöó SC THE ADVENTURE | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Realtime)</header>

<div class="toast" id="toastBox"><span id="toastText"></span></div>

<div class="container">
<div class="card">
<div class="grid">
<select id="vehicleSelect"></select>
<input id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå)">
<button onclick="openModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>
<button class="danger" onclick="confirmDeleteVehicle()">üóë ‡∏•‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
</div>

<div class="card">
<table class="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏ñ</th><th>‡∏£‡∏∞‡∏ö‡∏ö</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
<th>‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°</th><th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡∏ö</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="modal">
<div class="modal-box">
<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Ultra Detail)</h2>

<div class="card">
<div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ (Vehicle Identity)</div>
<div class="grid">
<input id="plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ">
<input id="brand" placeholder="‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠">
<input id="model" placeholder="‡∏£‡∏∏‡πà‡∏ô">
<input id="year" placeholder="‡∏õ‡∏µ‡∏£‡∏ñ">
<input id="vin" placeholder="VIN / Chassis No.">
<input id="engineNo" placeholder="Engine No.">
<input id="mileage" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
<input id="fuelType" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á">
<input id="usageType" placeholder="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
</div>
</div>

<div class="card">
<div class="section-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</div>
<div class="grid">
<input type="date" id="date">
<input id="system" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
<select id="jobType">
<option>PM - Preventive</option>
<option>CM - Corrective</option>
<option>Emergency</option>
<option>Accident</option>
</select>
<select id="priority">
<option>‡∏ï‡πà‡∏≥</option><option>‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏™‡∏π‡∏á</option><option>‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</option>
</select>
<select id="status">
<option class="NEW">NEW</option>
<option class="INPROGRESS">INPROGRESS</option>
<option class="DONE">DONE</option>
</select>
</div>
<textarea id="symptoms" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"></textarea>
<textarea id="rootCause" placeholder="Root Cause"></textarea>
<textarea id="diagnosis" placeholder="Diagnosis"></textarea>
<textarea id="repairMethod" placeholder="Repair Method"></textarea>
<textarea id="prevention" placeholder="Preventive Action"></textarea>
<textarea id="testResult" placeholder="Test Result"></textarea>
</div>

<div class="card">
<div class="section-title">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
<div class="grid">
<input id="technician" placeholder="‡∏ä‡πà‡∏≤‡∏á">
<input id="supervisor" placeholder="‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö">
<input id="vendor" placeholder="‡∏≠‡∏π‡πà / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
<input id="partsList" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">
<input id="partsCost" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">
<input id="laborCost" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á">
<input id="otherCost" type="number" placeholder="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
<input id="downtime" placeholder="Downtime">
<input id="warranty" placeholder="‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô">
</div>
<textarea id="remark" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
</div>

<div class="grid">
<button onclick="save()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button class="danger" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div>
</div>

<!-- CONFIRM -->
<div class="modal" id="confirmModal">
<div class="modal-box" style="max-width:420px">
<h3 id="confirmText"></h3>
<div class="grid">
<button id="confirmYes">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
<button class="danger" onclick="closeConfirm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCowDEvUQpBmq7AwUGiC6IuGOudPhi_0kM",
  authDomain:"vehicle-maintenance-64890.firebaseapp.com",
  projectId:"vehicle-maintenance-64890"
});
const db=firebase.firestore();

let unsubscribe=null,pendingAction=null;

const toastBox=document.getElementById("toastBox");
const toastText=document.getElementById("toastText");
function showToast(msg,type="success"){
  toastText.innerText=msg;
  toastBox.className="toast "+type;
  toastBox.style.display="block";
  setTimeout(()=>toastBox.style.display="none",3000);
}

function openModal(){modal.style.display="flex"}
function closeModal(){modal.style.display="none"}
function closeConfirm(){confirmModal.style.display="none"}

function loadVehicles(){
  db.collection("vehicles").onSnapshot(s=>{
    vehicleSelect.innerHTML="";
    s.forEach(d=>{
      let o=document.createElement("option");
      o.value=d.id;o.textContent=d.id;
      vehicleSelect.appendChild(o);
    });
    if(vehicleSelect.value) loadRepairs(vehicleSelect.value);
  });
}
vehicleSelect.onchange=()=>loadRepairs(vehicleSelect.value);

function loadRepairs(v){
  if(unsubscribe) unsubscribe();
  unsubscribe=db.collection("vehicles").doc(v).collection("repairs")
  .orderBy("createdAt","desc")
  .onSnapshot(s=>{
    tbody.innerHTML="";
    s.forEach(d=>{
      let r=d.data();
      let cost=(+r.partsCost||0)+(+r.laborCost||0)+(+r.otherCost||0);
      if(searchInput.value && !JSON.stringify(r).toLowerCase().includes(searchInput.value.toLowerCase())) return;
      tbody.innerHTML+=`
      <tr>
        <td>${r.date||""}</td>
        <td>${v}</td>
        <td>${r.system||""}</td>
        <td>${(r.symptoms||"").substring(0,60)}...</td>
        <td>${r.technician||""}</td>
        <td>${cost.toLocaleString()}</td>
        <td><span class="badge ${r.status}">${r.status}</span></td>
        <td><button class="danger" onclick="confirmDeleteRecord('${v}','${d.id}')">‡∏•‡∏ö</button></td>
      </tr>`;
    });
  });
}

function confirmDeleteVehicle(){
  confirmText.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?";
  pendingAction=()=>db.collection("vehicles").doc(vehicleSelect.value).delete();
  confirmModal.style.display="flex";
}
function confirmDeleteRecord(v,id){
  confirmText.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?";
  pendingAction=()=>db.collection("vehicles").doc(v).collection("repairs").doc(id).delete();
  confirmModal.style.display="flex";
}
confirmYes.onclick=()=>{pendingAction();closeConfirm()}

async function save(){
  try{
    const key=plate.value+" | "+brand.value+" "+model.value;
    const ref=db.collection("vehicles").doc(key);
    await ref.set({created:new Date()},{merge:true});
    await ref.collection("repairs").add({
      plate:plate.value,brand:brand.value,model:model.value,year:year.value,
      vin:vin.value,engineNo:engineNo.value,mileage:mileage.value,
      fuelType:fuelType.value,usageType:usageType.value,
      date:date.value,system:system.value,jobType:jobType.value,
      priority:priority.value,status:status.value,
      symptoms:symptoms.value,rootCause:rootCause.value,
      diagnosis:diagnosis.value,repairMethod:repairMethod.value,
      prevention:prevention.value,testResult:testResult.value,
      technician:technician.value,supervisor:supervisor.value,
      vendor:vendor.value,partsList:partsList.value,
      partsCost:partsCost.value,laborCost:laborCost.value,
      otherCost:otherCost.value,downtime:downtime.value,
      warranty:warranty.value,remark:remark.value,
      createdAt:new Date()
    });
    vehicleSelect.value=key;
    loadRepairs(key);
    closeModal();
    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ","success");
  }catch(e){
    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå","error");
  }
}

loadVehicles();
if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js");}
</script>
</body>
</html>
