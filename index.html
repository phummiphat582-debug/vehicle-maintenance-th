async function save(){

  // ✅ 1. กันพัง: ช่องบังคับ
  if(
    !plate.value.trim() ||
    !brand.value.trim() ||
    !model.value.trim()
  ){
    showToast("กรุณากรอก ทะเบียน / ยี่ห้อ / รุ่น ให้ครบ","error");
    return;
  }

  try{
    // ✅ 2. ทำ key ให้ปลอดภัย
    const key =
      plate.value.trim() +
      " | " +
      brand.value.trim() +
      " " +
      model.value.trim();

    const ref = db.collection("vehicles").doc(key);

    // ✅ 3. สร้างรถ (merge กันซ้ำ)
    await ref.set(
      {
        plate: plate.value.trim(),
        brand: brand.value.trim(),
        model: model.value.trim(),
        created: new Date()
      },
      { merge:true }
    );

    // ✅ 4. เพิ่มประวัติการซ่อม
    await ref.collection("repairs").add({
      plate:plate.value,
      brand:brand.value,
      model:model.value,
      year:year.value,
      vin:vin.value,
      engineNo:engineNo.value,
      mileage:mileage.value,
      fuelType:fuelType.value,
      usageType:usageType.value,

      date:date.value || "",
      system:system.value || "",
      jobType:jobType.value || "",
      priority:priority.value || "",
      status:status.value || "NEW",

      symptoms:symptoms.value,
      rootCause:rootCause.value,
      diagnosis:diagnosis.value,
      repairMethod:repairMethod.value,
      prevention:prevention.value,
      testResult:testResult.value,

      technician:technician.value,
      supervisor:supervisor.value,
      vendor:vendor.value,
      partsList:partsList.value,
      partsCost:Number(partsCost.value||0),
      laborCost:Number(laborCost.value||0),
      otherCost:Number(otherCost.value||0),
      downtime:downtime.value,
      warranty:warranty.value,
      remark:remark.value,

      createdAt:new Date()
    });

    // ✅ 5. refresh UI
    vehicleSelect.value = key;
    loadRepairs(key);
    closeModal();
    showToast("บันทึกข้อมูลสำเร็จ ✅","success");

  }catch(e){
    console.error("SAVE ERROR:",e);
    showToast("บันทึกไม่สำเร็จ ❌","error");
  }
}
